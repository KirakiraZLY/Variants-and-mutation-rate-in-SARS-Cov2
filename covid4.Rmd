---
title: "Covid_4"
author: "zly"
date: "2022-11-15"
output: html_document
---
```{r}
library(rehh)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(data.table)
library(DBI)
library(RSQLite)
library(scales)
library(data.table)
```

```{r}
filename <- file.choose()
covid_2<- readRDS(filename)
## 少的那个
covid_2 <- covid_2 %>%  filter(grepl(pattern = 'Spike', AASubstitutions))
# covid_2 <- df[complete.cases(covid),]
# colnames(covid_2)[names(covid_2) == 'GC-Content'] <- "GCContent"
# saveRDS(covid_2, file = filename)
```


## Week 12
Calculate real dn/ds
```{r}
covid_ns <- covid_2 %>% arrange(pangolin_lineage,date) 
# %>% filter(pangolin_lineage == c("BA.1","BA.2","BA.2.12.1","BA.4","BA.5","BF.7","BQ.1.1"))


# covid_2 <- covid_2[order(covid_2$pangolin_lineage,covid_2$date)]

covid_n_1 <- aggregate(covid_ns$count_N, by=list( covid_ns$pangolin_lineage,covid_ns$VarShort,covid_ns$date),mean)

# covid_ns <- data.frame(covid_ns,covid_ns_1)
names(covid_n_1) <- c("pangolin_lineage", "VarShort", "date", "count_N")

covid_n_1 <- covid_n_1[order(covid_n_1$pangolin_lineage,covid_n_1$date),]

# ggplot(covid_n_1, aes(x = date, y = count_N, color = pangolin_lineage)) +
#   geom_point() +
#   labs(title = "Count_N by lineage")

############### N ##############
############### S ##############

covid_s_1 <- aggregate(covid_ns$count_S, by=list(covid_ns$pangolin_lineage,covid_ns$VarShort,covid_ns$date),mean)
# covid_ns <- data.frame(covid_ns,covid_ns_1)
names(covid_s_1) <- c("pangolin_lineage", "VarShort", "date", "count_S")

covid_s_1 <- covid_s_1[order(covid_s_1$pangolin_lineage,covid_s_1$date),]

ggplot(covid_s_1, aes(x = date, y = count_S, color = VarShort)) +
  geom_point() +
  labs(title = "Count_S by lineage")

delta_N <- diff(covid_n_1$count_N)
delta_N <- c(0,delta_N)
covid_n_1$delta_N <- delta_N


delta_S <- diff(covid_s_1$count_S)
delta_S <- c(0,delta_S)
covid_s_1$delta_S <- delta_S

dnds <- data.frame(covid_s_1$date, covid_s_1$pangolin_lineage,delta_N/delta_S)
names(dnds) <- c("date","pangolin_lineage","dnds")


dnds <- dnds[!is.infinite(dnds$dnds),]
dnds <- dnds[!is.na(dnds$dnds),]

# ggplot(dnds, aes(x = date, y = dnds)) +
#   geom_point() +
#   ylim(-100,100) +
#   labs(title = "dNdS")

  
```


```{r}
delta_N <- diff(covid_ns$count_N)
delta_N <- c(0,delta_N)
covid_ns$delta_N <- delta_N


delta_S <- diff(covid_ns$count_S)
delta_S <- c(0,delta_S)
covid_ns$delta_S <- delta_S

covid_ns$dnds <- delta_N/delta_S

covid_ns <- covid_ns[!is.infinite(covid_ns$dnds),]
covid_ns <- covid_ns[!is.na(covid_ns$dnds),]

ggplot(covid_ns, aes(x = date, y = dnds, col = pangolin_lineage)) +
  geom_point()
```

## Week 12

```{r}
############ Linear Regression on N

covid_n_2 <- covid_2 %>% filter(VarShort == c("VOC Omicron GRA"))
fitted_N =  covid_n_2 %>% group_by(pangolin_lineage) %>% do(model = lm(count_N ~ date, data = .))
# plot(fitted_models$model)
# fitted_N$model
```

```{r}
######### Linear Regression on S
covid_s_2 <- covid_2%>% filter(VarShort == c("VOC Omicron GRA"))
fitted_S =  covid_s_2 %>% group_by(pangolin_lineage) %>% do(model = lm(count_S ~ date, data = .))
# plot(fitted_models$model)
# fitted_S$model
# fitted_S <- lm(count_S ~ date,covid_s_2, subset = (grp == "pango"))
# fitted_S
```

```{r}
ggplot(data = covid_n_2, mapping = aes(x = date, y = count_N, col = covid_n_2$pangolin_lineage)) +
  # geom_point() +
  xlab('date') +
  labs(title = "delta_N(slope)") +
  geom_smooth(method = lm)

ggplot(data = covid_n_2, mapping = aes(x = date, y = count_N, col = covid_n_2$pangolin_lineage)) +
  geom_point() +
  xlab('date') +
  labs(title = "count_N") +
  ylim(0,100)

ggplot(data = covid_s_2, mapping = aes(x = date, y = count_S, col = covid_s_2$pangolin_lineage)) +
  # geom_point() +
  xlab('date') +
  labs(title = "delta_S(slope)") +
  geom_smooth(method = lm)

ggplot(data = covid_s_2, mapping = aes(x = date, y = count_S, col = covid_s_2$pangolin_lineage)) +
  geom_point() +
  xlab('date') +
  labs(title = "count_S") +
  ylim(0,50)
```


## About Delta
```{r}
######### Linear Regression on S
covid_n_3 <- covid_2%>% filter(VarShort == c("VOC Delta GK"))
fitted_N_Delta =  covid_n_3 %>% do(model = lm(count_N ~ date, data = .))
# plot(fitted_models$model)
fitted_N_Delta$model
# fitted_S <- lm(count_S ~ date,covid_s_2, subset = (grp == "pango"))
# fitted_S

covid_s_3 <- covid_2%>% filter(VarShort == c("VOC Delta GK"))
fitted_S_Delta =  covid_s_3 %>% do(model = lm(count_S ~ date, data = .))
# plot(fitted_models$model)
fitted_S_Delta$model
```
For more lineages
```{r}
a <- list()
for (i in 1:455) {
  a[i] <- fitted_N[[2]][[i]][["coefficients"]][2] / fitted_S[[2]][[i]][["coefficients"]][2]
}
# dnds <- data.frame(matrix(nrow=0,ncol=2))
dnds <- data.frame(fitted_N$pangolin_lineage)
names(dnds) <- c("pangolin_lineage")
dnds$dNdS <- a

# dnds <- dnds[!is.na(dnds$dNdS),]

dnds[dnds$pangolin_lineage == "BA.2.1",]$dNdS
####### Haven't consider p<0.01



# ggplot(data = dnds, aes(x = pangolin_lineage, y = dNdS)) +
#   geom_bar(stat = 'identity')
```


FOR MULTIPLE LINEAGES
```{r}
lineage_name = c("BA.1","BA.2","BA.2.1","BA.2.75","BA.4","BA.5","BA.5.2.1","BF.7","BQ.1","BQ.1.1","BN.1","XBB")
# covid_specific <- covid_2 %>% filter(pangolin_lineage == lineage_name)
# covid_4 <- dnds[dnds$pangolin_lineage == lineage_name,]
dnds_multiple_dnds <- list()
dnds_multiple_lineage <- list()
for (i in 1:length(lineage_name))
{
  dnds_multiple_dnds[i] <- dnds[dnds$pangolin_lineage == lineage_name[i],]$dNdS
  dnds_multiple_lineage[i] <- dnds[dnds$pangolin_lineage == lineage_name[i],]$pangolin_lineage
}
dnds_multiple <- data.frame(dnds_multiple_lineage,dnds_multiple_dnds)


# dnds_multiple <- data.frame(dnds_multiple_lineage)
# names(dnds_multiple) <- c("pangolin_lineage")
# dnds$dNdS <- dnds_multiple_dnds

dnds_multiple <- cbind(dnds_multiple_lineage,dnds_multiple_dnds)
dnds_multiple <- as.data.frame(dnds_multiple)
names(dnds_multiple) <- c("pangolin_lineage","dNdS")
dnds_multiple$dNdS <- as.numeric(dnds_multiple$dNdS)
dnds_multiple$pangolin_lineage <- as.factor(lineage_name)

dnds_multiple$col<- ifelse(dnds_multiple$dNdS >= 1, 1, 0)
dnds_multiple$col<-as.factor(dnds_multiple$col)

ggplot(dnds_multiple, mapping = aes(x = dnds_multiple$pangolin_lineage, y = dnds_multiple$dNdS, col = dnds_multiple$col, fill = dnds_multiple$col)) +
  geom_bar(position="dodge",stat="identity") +
  labs(title = "dNdS_new in different Concern Lineages") +
  ylim(0,5)
```
Distribution of a specific lineage
```{r}
lineage_name = lineage_name
covid_specific <- covid_2 %>% filter(pangolin_lineage == lineage_name)
dnds[dnds$pangolin_lineage == lineage_name,]$dNdS


ggplot(data = covid_specific, mapping = aes(x = date, y = count_N, col = covid_specific$pangolin_lineage)) +
  # geom_point() +
  xlab('date') +
  labs(title = "delta_N(slope)") +
  geom_smooth(method = lm)

ggplot(data = covid_specific, mapping = aes(x = date, y = count_N, col = covid_specific$pangolin_lineage)) +
  geom_point() +
  xlab('date') +
  labs(title = "count_N")

ggplot(data = covid_specific, mapping = aes(x = date, y = count_S, col = covid_specific$pangolin_lineage)) +
  # geom_point() +
  xlab('date') +
  labs(title = "delta_S(slope)") +
  geom_smooth(method = lm)

ggplot(data = covid_specific, mapping = aes(x = date, y = count_S, col = covid_specific$pangolin_lineage)) +
  geom_point() +
  xlab('date') +
  labs(title = "count_S")

```
